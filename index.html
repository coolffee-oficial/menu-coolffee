<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COOLFFEE - Menú & Recibo</title>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;1,700;1,800&family=Inter:wght@300;400;700&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --brand-gold: #c29957; --line-red: #bc2c2c; --bg: #030303; --card-bg: #111; --text-product: #d1d1d1; --text-dim: #888; }
        body { background-color: var(--bg); color: #fff; font-family: 'Inter', sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 480px; padding: 20px 20px 120px; box-sizing: border-box; }
        
        .header-section { text-align: center; margin: 40px 0 30px; }
        .header-section h1 { font-family: 'Barlow Condensed', sans-serif; font-style: italic; font-weight: 700; color: var(--brand-gold); font-size: 3.2rem; margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        .red-bar { width: 100%; height: 2px; background-color: var(--line-red); margin-top: 5px; }

        .category-title { font-family: 'Barlow Condensed', sans-serif; font-style: italic; font-weight: 700; color: var(--brand-gold); font-size: 1.6rem; margin: 35px 0 15px; text-transform: uppercase; border-bottom: 1px solid #1a1a1a; padding-bottom: 5px; }
        .product { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 10px; }
        .p-info { flex: 1; }
        .p-info h3 { margin: 0; font-size: 1.05rem; color: var(--text-product); font-weight: 700; text-transform: uppercase; }
        .p-info p { margin: 3px 0 0; font-size: 0.8rem; color: var(--text-dim); line-height: 1.2; }
        
        .p-prices { display: flex; gap: 8px; flex-shrink: 0; }
        .p-opt { color: #fff; font-size: 0.85rem; cursor: pointer; border: 1px solid #333; width: 75px; height: 38px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 6px; background: #111; transition: 0.2s; line-height: 1; }
        .p-opt:active { transform: scale(0.95); background: #222; }
        .p-opt span { color: var(--brand-gold); font-weight: bold; margin-top: 2px; }
        .p-opt small { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; }

        #view-cart-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: var(--brand-gold); color: #000; padding: 15px; border-radius: 50px; text-align: center; font-weight: 800; cursor: pointer; display: none; z-index: 999; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-transform: uppercase; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 1001; }
        .modal-content { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: var(--card-bg); border-top: 3px solid var(--brand-gold); border-radius: 25px 25px 0 0; padding: 25px; box-sizing: border-box; max-height: 90vh; overflow-y: auto; color: #fff; }
        
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #222; }
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .qty-btn { background: transparent; border: 1px solid var(--brand-gold); color: var(--brand-gold); width: 28px; height: 28px; border-radius: 50%; font-weight: bold; cursor: pointer; }

        .form-group { margin-top: 18px; }
        .form-group label { display: block; font-size: 0.7rem; color: var(--brand-gold); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: inherit; }
        
        .main-btn { background: var(--brand-gold); color: #000; padding: 16px; border-radius: 50px; border: none; width: 100%; font-weight: 800; text-transform: uppercase; margin-top: 25px; cursor: pointer; }
        .secondary-btn { background: none; border: none; color: var(--text-dim); width: 100%; margin-top: 15px; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }

        /* --- ESTILOS EXCLUSIVOS DEL RECIBO PREMIUM --- */
        #recibo-digital {
            display: none; /* Oculto en la web, solo para el PDF */
            width: 580px; background: #C29957; color: #1C1203; padding: 50px 40px;
            position: relative; box-sizing: border-box; border: 4px solid #1C1203;
        }
        .recibo-header h1 { 
            font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-style: italic; 
            font-size: 75px; text-transform: uppercase; margin: 0; line-height: 0.85; text-align: center;
            text-shadow: 2px 2px 0px #dec08a, 3px 3px 0px #1C1203;
        }
        .recibo-slogan { font-family: 'Dancing Script', cursive; font-size: 26px; text-align: center; margin-top: 5px; font-weight: 600; }
        .recibo-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; 
            border-top: 2px solid #1C1203; border-bottom: 2px solid #1C1203; padding: 18px 0;
        }
        .recibo-item b { font-size: 9px; text-transform: uppercase; display: block; opacity: 0.7; }
        .recibo-item span { font-size: 14px; }
        .recibo-tabla { width: 100%; margin-top: 25px; border-collapse: collapse; }
        .recibo-tabla th { text-align: left; border-bottom: 2px solid #1C1203; font-size: 10px; text-transform: uppercase; padding: 8px; }
        .recibo-tabla td { padding: 10px 8px; border-bottom: 1px solid rgba(28, 18, 3, 0.2); font-size: 12px; }
        .recibo-total-box { 
            background: #1C1203; color: #C29957; padding: 12px 25px; 
            display: inline-block; text-align: right; border-radius: 3px; margin-top: 20px;
        }
        .recibo-total-box h2 { margin: 0; font-size: 35px; font-family: 'Barlow Condensed', sans-serif; font-style: italic; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header-section">
            <h1>COOLFFEE</h1>
            <div class="red-bar"></div>
        </div>
        <div id="menu-content">Cargando menú...</div>
    </div>

    <div id="view-cart-btn" onclick="openModal('cart')">Ver Pedido (<span id="btn-qty">0</span>) - $<span id="btn-total">0.00</span></div>

    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content">
            <div id="step-cart">
                <h2 style="color:var(--brand-gold); text-transform:uppercase; margin-top:0;">Resumen</h2>
                <div id="cart-list"></div>
                <div style="text-align:right; font-size:1.4rem; margin: 20px 0; font-weight:700;">TOTAL: <span style="color:var(--brand-gold)">$<span id="modal-total">0.00</span></span></div>
                <button class="main-btn" onclick="openModal('form')">Confirmar Pedido</button>
                <button class="secondary-btn" onclick="closeModal()">+ Agregar más productos</button>
            </div>

            <div id="step-form" style="display:none;">
                <h2 style="color:var(--brand-gold); text-transform:uppercase; margin-top:0;">Datos de Entrega</h2>
                <div class="form-group"><label>Nombre y Apellido</label><input type="text" id="c-nombre"></div>
                <div class="form-group"><label>Cédula</label><input type="number" id="c-cedula"></div>
                <div class="form-group"><label>Teléfono</label><input type="tel" id="c-telefono"></div>
                <div class="form-group">
                    <label>Tipo de Entrega</label>
                    <select id="c-entrega" onchange="toggleDeliveryFields(this.value)">
                        <option value="Pick Up">Pick Up (Retiro en local)</option>
                        <option value="Delivery">Delivery</option>
                    </select>
                </div>
                <div id="div-dir" style="display:none">
                    <div class="form-group"><label>Dirección</label><textarea id="c-direccion"></textarea></div>
                </div>
                <div class="form-group">
                    <label>Método de Pago</label>
                    <select id="c-pago">
                        <option value="Pago Móvil">Pago Móvil</option>
                        <option value="Binance">Binance</option>
                        <option value="Efectivo Divisas">Efectivo Divisas</option>
                    </select>
                </div>
                <button class="main-btn" onclick="sendOrder()">Enviar a WhatsApp</button>
                <button class="secondary-btn" onclick="openModal('cart')">← Volver al carrito</button>
            </div>
        </div>
    </div>

    <div id="recibo-digital">
        <div class="recibo-header">
            <h1>COOLFFEE</h1>
            <div class="recibo-slogan">Tomatelo con calma...</div>
        </div>
        <div class="recibo-grid">
            <div class="recibo-item"><b>Cliente:</b><span id="r-nombre"></span></div>
            <div class="recibo-item" style="text-align:right;"><b>Fecha:</b><span id="r-fecha"></span></div>
            <div class="recibo-item"><b>Cédula:</b><span id="r-cedula"></span></div>
            <div class="recibo-item" style="text-align:right;"><b>Orden ID:</b><span id="r-id"></span></div>
        </div>
        <table class="recibo-tabla">
            <thead><tr><th>Cant.</th><th>Descripción</th><th style="text-align:right;">Total</th></tr></thead>
            <tbody id="r-cuerpo"></tbody>
        </table>
        <div style="text-align:right; margin-top:20px;">
            <div class="recibo-total-box">
                <span style="font-size:10px; text-transform:uppercase;">Total a Pagar</span>
                <h2 id="r-total"></h2>
            </div>
            <p id="r-metodo" style="font-size:9px; margin-top:5px; text-transform:uppercase;"></p>
        </div>
        <div style="text-align:center; margin-top:30px; font-size:10px; letter-spacing:2px; opacity:0.6;">*** PREMIUM COFFEE EXPERIENCE ***</div>
    </div>

    <script>
        const sheetId = '1dHPXGveUToshD1fKRnEf0EwdNnTNE3EuvYTQA3200q8';
        const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Productos`;
        let cart = [];

        async function loadMenu() {
            try {
                const res = await fetch(base);
                const text = await res.text();
                const lines = text.split('\n').slice(1);
                const menu = {};
                lines.forEach(line => {
                    const columns = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s?.replace(/"/g, '').trim());
                    const categoria = columns[1];
                    if (!menu[categoria]) menu[categoria] = [];
                    const p1 = columns[4], p2 = columns[5];
                    const opts = [];
                    if (p1) opts.push({ label: p2 ? '12oz' : 'Ver', price: parseFloat(p1.replace(',', '.')) });
                    if (p2) opts.push({ label: '16oz', price: parseFloat(p2.replace(',', '.')) });
                    menu[categoria].push({ categoria, nombre: columns[2], descripcion: columns[3], opts });
                });
                renderMenu(menu);
            } catch (e) { console.error(e); }
        }

        function renderMenu(menu) {
            const container = document.getElementById('menu-content');
            container.innerHTML = '';
            for (const cat in menu) {
                container.innerHTML += `<h2 class="category-title">${cat}</h2>`;
                menu[cat].forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'product';
                    div.innerHTML = `<div class="p-info"><h3>${p.nombre}</h3><p>${p.descripcion}</p></div>
                        <div class="p-prices">${p.opts.map(o => `
                            <div class="p-opt" onclick="addToCart('${p.categoria}', '${p.nombre}', '${o.label}', ${o.price})">
                                <small>${o.label==='Ver'?'':o.label}</small><span>$${o.price.toFixed(2)}</span>
                            </div>`).join('')}</div>`;
                    container.appendChild(div);
                });
            }
        }

        function addToCart(cat, name, size, price) {
            const sz = size === 'Ver' ? '' : size;
            const id = cat + name + sz;
            const item = cart.find(i => i.id === id);
            if (item) item.qty++;
            else cart.push({ id, cat, name, size: sz, price: parseFloat(price), qty: 1 });
            updateUI();
        }

        function updateUI() {
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const count = cart.reduce((s, i) => s + i.qty, 0);
            document.getElementById('view-cart-btn').style.display = count > 0 ? 'block' : 'none';
            document.getElementById('btn-qty').innerText = count;
            document.getElementById('btn-total').innerText = total.toFixed(2);
            document.getElementById('modal-total').innerText = total.toFixed(2);
            document.getElementById('cart-list').innerHTML = cart.map((item, index) => `
                <div class="cart-item">
                    <div><strong>${item.name}</strong> <small>${item.size}</small><br>$${item.price.toFixed(2)}</div>
                    <div class="qty-controls">
                        <button class="qty-btn" onclick="changeQty(${index}, -1)">-</button>
                        <span>${item.qty}</span>
                        <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                    </div>
                </div>`).join('');
        }

        function changeQty(i, d) {
            cart[i].qty += d;
            if (cart[i].qty <= 0) cart.splice(i, 1);
            updateUI();
            if (cart.length === 0) closeModal();
        }

        function toggleDeliveryFields(v) { document.getElementById('div-dir').style.display = v === 'Delivery' ? 'block' : 'none'; }
        function openModal(s) { 
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('step-cart').style.display = s === 'cart' ? 'block' : 'none';
            document.getElementById('step-form').style.display = s === 'form' ? 'block' : 'none';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function sendOrder() {
            const nom = document.getElementById('c-nombre').value;
            const tlf = document.getElementById('c-telefono').value;
            if(!nom || !tlf) return alert("Por favor completa los campos.");

            const code = 'CF-' + Math.random().toString(36).substr(2, 5).toUpperCase();
            const fecha = new Date().toLocaleDateString();
            const totalStr = document.getElementById('modal-total').innerText;

            // LLENAR RECIBO ANTES DE GENERAR PDF
            document.getElementById('r-nombre').innerText = nom.toUpperCase();
            document.getElementById('r-cedula').innerText = document.getElementById('c-cedula').value;
            document.getElementById('r-fecha').innerText = fecha;
            document.getElementById('r-id').innerText = code;
            document.getElementById('r-total').innerText = `$${totalStr}`;
            document.getElementById('r-metodo').innerText = `Pago: ${document.getElementById('c-pago').value} | Entrega: ${document.getElementById('c-entrega').value}`;
            
            let htmlTabla = "";
            cart.forEach(i => {
                htmlTabla += `<tr><td>${i.qty}</td><td>${i.cat.toUpperCase()} ${i.name} ${i.size ? '('+i.size+')' : ''}</td><td style="text-align:right;">$${(i.price*i.qty).toFixed(2)}</td></tr>`;
            });
            document.getElementById('r-cuerpo').innerHTML = htmlTabla;

            // DESCARGAR PDF
            const element = document.getElementById('recibo-digital');
            element.style.display = 'block'; // Mostrar para la captura
            const opt = {
                margin: 0,
                filename: `Recibo_${code}_COOLFFEE.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, backgroundColor: '#C29957' },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                element.style.display = 'none'; // Ocultar después
            });

            // ENVIAR WHATSAPP
            let msg = `*PEDIDO #${code} - COOLFFEE*\n*Cliente:* ${nom}\n*Total:* $${totalStr}\n\n*PRODUCTOS:*\n`;
            msg += cart.map(i => `- ${i.qty}x ${i.name} (${i.size})`).join('\n');
            window.open(`https://wa.me/584167492934?text=${encodeURIComponent(msg)}`, '_blank');
        }

        loadMenu();
    </script>
</body>
</html>
